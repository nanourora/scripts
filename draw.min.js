function addBoard(){boards[currentBoard]=primaryBoard.getImg(),$(".thumbnail_container").removeClass("active"),$("#thumbnails").append("<div class='thumbnail_container'><span>"+boards.length+"</span><img id='thumbnail_"+boards.length+"' src='' data-thumb-id="+boards.length+"><i class='far fa-edit'></i></div>"),$(".thumbnail_container").eq(boards.length-1).addClass("active"),currentBoard=boards.length,$(".drawing-board-control-navigation-reset").click(),boards[currentBoard]=primaryBoard.getImg()}function disableText(){textEnabled=!1,$(".text-button").removeClass("active"),0!==$("#textAreaPopUp").length&&($("textarea#canvastextarea").remove(),$("#saveText").remove(),$("#textAreaPopUp").remove())}function initialiseBoard(a){$("#thumbnails").append("<div class='thumbnail_container'><span>"+currentBoard+"</span><img id='thumbnail_"+currentBoard+"' src='' data-thumb-id="+currentBoard+"><i class='far fa-edit'></i></div>"),boardEmpty=!0;var e=new DrawingBoard.Board(a,{controls:["Color",{Size:{type:"dropdown"}},{DrawingMode:{filler:!1}},"Navigation"],background:!1,size:5,controlsPosition:"top center",droppable:!0});return DrawingBoard.Control.Share=DrawingBoard.Control.extend({name:"share",initialize:function(){this.$el.append('<button class="drawing-board-control share-button"><i class="fa-solid fa-share-nodes"></i></button>'),this.$el.on("click",".share-button",$.proxy(function(){TogetherJS(),$(".share-button").toggleClass("active")},this))}}),DrawingBoard.Control.Text=DrawingBoard.Control.extend({name:"text",initialize:function(){this.$el.append('<button class="drawing-board-control text-button"><i class="fa-regular fa-keyboard"></i></button>'),this.$el.on("click",".text-button",$.proxy(function(){textEnabled?disableText():(textEnabled=!0,$(".text-button").addClass("active"))},this))}}),e.addControl("Text"),e.addControl("Share"),e.ev.bind("board:userAction",function(){boards[currentBoard]=e.getImg(),boardEmpty=!1,$("#thumbnail_"+currentBoard).attr("src",boards[currentBoard])}),e.ev.bind("board:reset",function(){console.log("clear"),boards[currentBoard]=e.getImg(),boardEmpty=!0,disableText(),$("#thumbnail_"+currentBoard).attr("src",boards[currentBoard])}),e}function saveAs(a,e){var t=document.createElement("a");"string"==typeof t.download?(t.href=a,t.download=e,document.body.appendChild(t),t.click(),document.body.removeChild(t)):window.open(a)}function openPage(){var a=null;PDFJS.getDocument(pdfDoc).then(function(e){return console.log("the pdf has ",e.numPages,"page(s)."),PDFJS.disableStream=!0,console.log(e.numPages),a=e,e.getPage(pageNumber)}).then(function(a){boardEmpty||addBoard(),viewport=a.getViewport(1);var e=window.devicePixelRatio||1;canvas=document.querySelector("canvas");var t=1!==e?[e,0,0,e,0,0]:null,r={canvasContext:canvas.getContext("2d"),transform:t,viewport:viewport};return a.render(r).promise}).then(function(){boards[currentBoard]=primaryBoard.getImg(),boardEmpty=!1,$("#thumbnail_"+currentBoard).attr("src",boards[currentBoard]),primaryBoard.ev.trigger("board:userAction"),pageNumber+=1,pageNumber<=a.numPages?(addBoard(),openPage(a)):primaryBoard.saveHistory()})}function saveTextFromArea(a,e){var t=$("textarea#canvastextarea").val();$("textarea#canvastextarea").remove(),$("#saveText").remove(),$("#textAreaPopUp").remove();var r=document.querySelector("canvas"),n=r.getContext("2d");n.scale(1,1),n.font="20px serif",n.fillText(t,e,a),primaryBoard.saveHistory(),disableText(),primaryBoard.ev.trigger("board:userAction")}var textEnabled=!1,boards=[],primaryBoard=null,currentBoard=0,boardEmpty=!0,panzoom=null;!function(){currentBoard++,startSessionTimer(),$(".primary-canvas").height(.75*$(".primary-canvas").width()),$("#canvas").height(.75*$("#canvas").width()),primaryBoard=initialiseBoard("canvas"),$("canvas").attr("width",$("canvas").width()),$(".drawing-board-control-navigation-reset").click(),$(".thumbnail_container").removeClass("active"),$(".thumbnail_container").eq(currentBoard-1).addClass("active"),$("#thumbnails").on("click",".thumbnail_container",function(){if(disableText(),!$(this).hasClass("active")){var a=$(this).find("img");currentBoard=a.data("thumb-id");var e=a.attr("src");console.log(e),$(".drawing-board-control-navigation-reset").click();var t=new Image,r=document.querySelector("canvas");t.onload=function(){r.getContext("2d").drawImage(t,0,0),primaryBoard.saveHistory(),primaryBoard.ev.trigger("board:userAction")},t.src=e,$(".thumbnail_container").removeClass("active"),$(".thumbnail_container").eq(currentBoard-1).addClass("active")}})}(),$("#export-pdf-button").on("click",function(){disableText();const a=new jspdf.jsPDF({orientation:"l",unit:"in",format:[Math.floor(primaryBoard.canvas.width/72),Math.floor(primaryBoard.canvas.height/72)]});$(".thumbnail_container").each(function(e){var t=$(this).find("img"),r=t.attr("src");a.addImage(r,"PNG",0,0),e<boards.length-2&&a.addPage()}),a.save("download.pdf")}),$("#add-canvas-button").on("click",function(){addBoard()});var pdfDoc=null;document.querySelector("#pdf-upload").addEventListener("change",function(a){disableText();var e=a.target.files[0];if("application/pdf"!=e.type)return void console.error(e.name,"is not a pdf file.");var t=new FileReader;t.onload=function(){pdfDoc=new Uint8Array(this.result),openPage()},t.readAsArrayBuffer(e)});var pageNumber=1,canvas=null,timer=new easytimer.Timer;timer.start(),timer.addEventListener("secondsUpdated",function(){$("#basicUsage").html(timer.getTimeValues().toString())}),$("canvas").on("click",function(a){if(textEnabled){0!==$("#textAreaPopUp").length&&($("textarea#canvastextarea").remove(),$("#saveText").remove(),$("#textAreaPopUp").remove());var e=$("#canvas").offset(),t=a.pageX-e.left,r=a.pageY-e.top;console.log(t+","+r);var n="<div id='textAreaPopUp' style='position:absolute;top:"+r+"px;left:"+t+"px;z-index:30;'><textarea id='canvastextarea' style='width:120px;height:30px;'></textarea>",o="<input type='button' value='save' id='saveText' onclick='saveTextFromArea("+r+","+t+");'></div>",i=n+o;primaryBoard.goBackInHistory(),$("#canvas").append(i),$("#canvastextarea").focus()}});
